# Hydra-style config for power-stability-radius.
# This file is the single source of defaults for the unified CLI.
#
# CLI flags override values from this file.

run_tests: true

units:
  # 1 -> fail fast on invalid/ambiguous electrical quantities (recommended)
  # 0 -> legacy permissive behavior (may silently skip invalid branches)
  strict_units: 1

  # Phase shifting transformers (shift_degree != 0) are NOT modeled by the project's DC model.
  # By default we fail fast to avoid silently inconsistent OPF/DCOperator behavior.
  # Set to 1 only if you explicitly accept "phase shift is ignored".
  allow_phase_shift: 0

logging:
  runs_dir: runs
  level_console: INFO
  level_file: DEBUG

  # timestamp  -> runs/<timestamp>/
  # overwrite  -> runs/<run_name>/  (folder is deleted/recreated each run)
  run_dir_mode: timestamp
  run_name: latest

opf:
  # Project policy: must be "highs"
  solver_name: highs
  threads: 14
  random_seed: 42

  # NOTE:
  # PyPSA requires finite thermal limits. We use this value as a deterministic surrogate
  # for "unconstrained" lines (rateA==0 / +inf / NaN).
  #
  # Keep it large enough to never bind in realistic cases, but NOT astronomically large:
  # values like 1e9 can trigger HiGHS scaling warnings and lead to measurable numerical
  # drift (e.g., OPF->DCOperator flow mismatches at MW level).
  unconstrained_line_nom_mw: 1.0e6

dc:
  mode: operator
  chunk_size: 256
  dtype: float64

tolerances:
  opf_dc_flow_consistency_tol_mw: 5
  opf_bus_balance_tol_mw: 5

table:
  # Default table columns used by `demo` when `--table-columns` is empty.
  default_columns:
    - flow0_mw
    - p0_mw
    - p_limit_mw_est
    - margin_mw
    - norm_g
    - metric_denom
    - sigma_flow
    - radius_l2
    - radius_metric
    - radius_sigma
    - overload_probability
    - radius_nminus1
    - worst_contingency
    - worst_contingency_line_idx

demo:
  input: data/input/pglib_opf_case30_ieee.m
  slack_bus: 0

  dc_mode: ${dc.mode}
  dc_chunk_size: ${dc.chunk_size}
  dc_dtype: ${dc.dtype}

  margin_factor: 1.0
  inj_std_mw: 1.0

  compute_nminus1: 0
  nminus1_update_sensitivities: 1
  nminus1_islanding: skip

  export_results: ""
  save_csv: 1
  max_rows: null

  # comma-separated, empty -> table.default_columns
  table_columns: ""

monte_carlo:
  # required by CLI, defaults are placeholders
  results: ""
  input: ""
  slack_bus: 0

  n_samples: 50000
  seed: 0
  chunk_size: 256

  # Deprecated / ignored in current MC implementation; kept for backward-compatibility.
  box_radius_quantile: 0.1

  # Extra MC constants (previously hard-coded defaults)
  box_feas_tol_mw: 0.0
  cert_tol_mw: 1
  cert_max_samples: 5000

report:
  results_dir: verification/results
  out: verification/report.md

  n_samples: ${monte_carlo.n_samples}
  seed: ${monte_carlo.seed}
  chunk_size: ${monte_carlo.chunk_size}

  # Deprecated / ignored in current MC implementation; kept for backward-compatibility.
  box_radius_quantile: ${monte_carlo.box_radius_quantile}

  # Monte Carlo constants used during report generation
  box_feas_tol_mw: ${monte_carlo.box_feas_tol_mw}
  cert_tol_mw: ${monte_carlo.cert_tol_mw}
  cert_max_samples: ${monte_carlo.cert_max_samples}

  generate_missing_results: 1

  # Parameters used when auto-generating missing results.json
  demo:
    dc_mode: ${demo.dc_mode}
    slack_bus: ${demo.slack_bus}
    compute_nminus1: ${demo.compute_nminus1}

    dc_chunk_size: ${demo.dc_chunk_size}
    dc_dtype: ${demo.dc_dtype}

    margin_factor: ${demo.margin_factor}
    inj_std_mw: ${demo.inj_std_mw}

    nminus1_update_sensitivities: ${demo.nminus1_update_sensitivities}
    nminus1_islanding: ${demo.nminus1_islanding}

table_cmd:
  # Used only for defaults; the command requires positional results_json anyway.
  max_rows: null
  radius_field: radius_l2
  columns: ""
  table_out: ""
  csv_out: ""
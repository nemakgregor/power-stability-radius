# Units contract (явный контракт единиц измерения)

Этот документ фиксирует **единицы измерения** и **правила преобразований**, которые считаются
инвариантами проекта `power-stability-radius`. Нарушение контракта должно приводить к явной ошибке
(см. `strict_units`), а не к “молчаливым” нулям/NaN.

## 1) Базовые величины (DC-модель)

| Сущность | Обозначение в коде | Единицы |
|---|---|---|
| Активная мощность (инъекции) | `p_mw`, `bus_injections_mw`, `Δp` | **MW** |
| Потоки по линиям | `flow0_mw`, `f0`, `Δf` | **MW** |
| Предел (симметричный) | `c`, `p_limit_*` | **MW** *(см. PF=1 ниже)* |
| Запас до предела | `margin_mw` | **MW** |
| Нарушение ограничения | `violation_*_mw` | **MW** |
| Угол | `theta`, `θ` | **rad** |
| Сопротивление/реактивность ветви | `r_ohm`, `x_ohm` | **Ohm** |
| Номинальное напряжение шины | `vn_kv`, `v_nom` | **kV** |

DC-ветвь использует коэффициент (поддержка PTDF/DCOperator):
- `b = V_kV^2 / X_ohm`  с единицами **MW/rad** (поскольку `Δf = b·Δθ` и `Δf` в MW, `Δθ` в rad).

Проектная политика:
- **lossless DC**: `r` игнорируется (в OPF `r=0.0`, в DCOperator используется только `x`).

## 2) Тепловые пределы: MVA vs MW (PF=1 в DC)

Источники рейтингов в исходных данных (MATPOWER/PGLib/pandapower):
- `rateA`, `sn_mva`, `max_mva` — **MVA**

В DC-постановке проекта используется только активная мощность (P). Поэтому применяется явное правило:
- **PF=1** (для DC-ограничений) ⇒ `P_limit_mw := S_limit_mva`

Т.е. в коде часто хранится “лимит в MW”, который фактически является “лимитом в MVA, интерпретированным как MW”.

Рекомендованная семантика имени:
- `limit_mva_assumed_mw` (внутри кода / dataclass)
- в results.json для обратной совместимости сохранён ключ `p_limit_mw_est`.

## 3) PyPSA unit contract (важно)

PyPSA `Line` ожидает:
- `r` **в Ohm**
- `x` **в Ohm**
- `Bus.v_nom` **в kV**
- `Line.s_nom` **в MVA** (для DC с PF=1 используется как MW)

Ошибки вида “передали per-unit вместо Ohm” обычно не видны в одноуровневых сетях,
но ломают физику в multi-voltage и ловятся тестом масштабной инвариантности.

## 4) Режим `strict_units=True` (fail-fast)

При `strict_units=True` запрещено:
- `vn_kv <= 0`
- `x_ohm <= 0` (для lossless DC ветвей)
- `sn_mva <= 0` (для трансформаторов и системной базы)

Запрещено “молчаливо” возвращать `0.0` для таких параметров.

## 5) Phase shifting transformers: `shift_degree`

Текущая DC-модель проекта **не моделирует** фазосдвигающие трансформаторы (`shift_degree != 0`).
По умолчанию:
- `allow_phase_shift=False` ⇒ **raise**
- `allow_phase_shift=True` ⇒ допускаем, но явно логируем WARNING и игнорируем фазовый сдвиг

Это сделано, чтобы избежать “тихих” несовместимостей OPF↔DCOperator.